# Универсальный Финансовый Отчет

Это веб-приложение представляет собой интерактивную панель для анализа личных финансов. Оно позволяет загружать CSV-файл с данными о транзакциях, визуализировать структуру доходов и расходов, выполнять семантический поиск и кластеризовать транзакции для выявления скрытых закономерностей.

## Возможности

*   **Загрузка CSV**: Простая загрузка и обработка вашего CSV-файла с финансовыми данными.
*   **Фильтрация данных**:
    *   **Исключение "Долгов"**: Возможность исключить транзакции, связанные с долговыми счетами.
    *   **Фильтр по дате**: Фильтрация данных по конкретному месяцу и/или году.
*   **Финансовая сводка**: Автоматический расчет и отображение общего дохода, общих расходов и чистого баланса.
*   **Визуализация расходов**:
    *   **По категориям**: Интерактивная кольцевая диаграмма, показывающая распределение расходов по категориям.
    *   **По магазинам**: Горизонтальная столбчатая диаграмма с топ-10 тратами по магазинам и сервисам.
    *   **Поиск аномалий**: Кнопка "Найти аномалии в данных" для выявления необычных транзакций, интегрированная в раздел "Структура расходов".
*   **Анализ доходов**: Наглядное отображение источников дохода и их долей в общей сумме.
*   **Семантический поиск**: Поиск транзакций по смыслу, используя эмбеддинги, сгенерированные AI.
*   **Кластеризация DBSCAN**: Автоматическая группировка похожих транзакций на основе их числовых значений и семантических эмбеддингов. Результаты кластеризации сохраняются в базе данных и визуализируются.
*   **Прогнозирование доходов и расходов**: Комплексная система прогнозирования с использованием различных моделей машинного обучения:
    *   **Классические ML-модели**: Линейная регрессия, скользящее среднее, экспоненциальное сглаживание
    *   **Модели временных рядов**: ARIMA-подобные модели для анализа трендов и сезонности
    *   **Prophet-подобная модель**: Продвинутое прогнозирование с учетом сезонности и трендов
    *   **Ансамбль моделей**: Комбинирование нескольких моделей для повышения точности
    *   **Метрики точности**: MAE, RMSE, MAPE для оценки качества прогнозов
    *   **Анализ сезонности**: Автоматическое обнаружение сезонных паттернов в данных
    *   **Доверительные интервалы**: Оценка неопределенности прогнозов

## Как использовать

1.  **Настройка Supabase**:
    *   Убедитесь, что у вас есть база данных Supabase с таблицей `transactions`.
    *   Добавьте колонку `cluster_id` в вашу таблицу `transactions`, выполнив следующий SQL-запрос в SQL Editor Supabase:
        ```sql
        ALTER TABLE transactions
        ADD COLUMN cluster_id INT;
        ```
2.  **Развертывание на Vercel**:
    *   Подключите ваш GitHub репозиторий к Vercel
    *   Vercel автоматически обнаружит API-маршруты в директории `api/`
    *   Настройте переменные окружения в панели Vercel:
        ```
        SUPABASE_URL=your_supabase_project_url
        SUPABASE_ANON_KEY=your_supabase_anon_key
        GEMINI_API_KEY=your_gemini_api_key
        ```
    *   Файл `vercel.json` уже настроен для оптимальной работы функций прогнозирования
3.  **Откройте приложение**: Откройте URL вашего развернутого приложения на Vercel.
4.  **Загрузите CSV-файл**: Нажмите на кнопку выбора файла и загрузите ваш CSV-файл с транзакциями.
    *   **Формат CSV**: Убедитесь, что ваш файл использует точку с запятой (`;`) в качестве разделителя и содержит заголовки, соответствующие формату экспорта из приложения [ZenMoney](https://zenmoney.ru/). Пример необходимых заголовков: `date;categoryName;payee;comment;outcomeAccountName;outcome;outcomeCurrencyShortTitle;incomeAccountName;income;incomeCurrencyShortTitle;createdDate;changedDate;qrCode`.
5.  **Примените фильтры (опционально)**:
    *   Установите флажок "Исключить 'Долги'", чтобы убрать долговые операции.
    *   Выберите месяц и/или введите год для анализа конкретного периода.
6.  **Запустите кластеризацию**: В секции "Кластеризация транзакций (DBSCAN)" нажмите кнопку "Запустить кластеризацию". Результаты будут сохранены в Supabase и отображены на круговой диаграмме.
    *   **Настройка параметров DBSCAN**: В файле `api/cluster-transactions.js` вы можете настроить параметры `eps` (радиус окрестности) и `minPts` (минимальное количество точек в окрестности) для алгоритма DBSCAN. Эти параметры сильно влияют на результаты кластеризации.
7.  **Используйте семантический поиск**: Введите запрос в поле "Семантический поиск по транзакциям" и нажмите "Найти", чтобы найти похожие транзакции.
8.  **Создайте прогнозы**: В разделе "Прогнозирование доходов и расходов":
    *   Выберите модель прогнозирования (линейная регрессия, скользящее среднее, ARIMA, Prophet-подобная, ансамбль)
    *   Укажите тип прогноза (доходы или расходы)
    *   Установите количество периодов для прогнозирования (1-24 месяца)
    *   Опционально укажите категорию для фокусированного прогноза
    *   Нажмите "Создать прогноз" для генерации индивидуального прогноза
    *   Используйте "Сравнить модели" для сравнения всех доступных моделей
9.  **Анализируйте результаты прогнозирования**:
    *   Изучите график временного ряда с историческими данными и прогнозом
    *   Просмотрите метрики точности (MAE, RMSE, MAPE)
    *   Оцените информацию о сезонности данных
    *   Изучите детальную таблицу прогнозов с доверительными интервалами
10. **Изучите отчет**: Просмотрите сводку, диаграммы и результаты поиска/кластеризации/прогнозирования на панели.

## Структура проекта

*   `index.html`: Основной файл, содержащий всю структуру, стили (Tailwind CSS) и логику фронтенда (JavaScript).
*   `api/`: Директория, содержащая Vercel Serverless Functions (API-маршруты):
    *   `api/get-transactions.js`: Получение транзакций из Supabase.
    *   `api/upload-transactions.js`: Загрузка транзакций в Supabase, включая генерацию эмбеддингов.
    *   `api/semantic-search.js`: Выполнение семантического поиска по транзакциям.
    *   `api/cluster-transactions.js`: Выполнение кластеризации DBSCAN и сохранение результатов.
    *   `api/deep-analysis.js`: Глубокий анализ трат с использованием ИИ.
    *   `api/detect-anomalies.js`: Обнаружение аномалий в транзакциях.
    *   `api/forecast-transactions.js`: Прогнозирование доходов и расходов с использованием различных ML-моделей.
*   `README.md`: Этот файл.
*   `package.json`: Описание проекта и его зависимостей.
*   `package-lock.json`: Зафиксированные версии зависимостей.
*   `supabase_vector_setup.sql`: SQL-скрипт для настройки векторного поиска в Supabase.

## Используемые технологии

*   HTML5
*   [Tailwind CSS](https://tailwindcss.com/)
*   JavaScript (ES6+)
*   [Chart.js](https://www.chartjs.org/)
*   [Google Gemini API](https://ai.google.dev/) (используемая модель: `embedding-001` для эмбеддингов)
*   [Supabase](https://supabase.com/) (как база данных и векторное хранилище)
*   [Vercel](https://vercel.com/) (для развертывания Serverless Functions и фронтенда)
*   [density-clustering](https://www.npmjs.com/package/density-clustering) (для кластеризации DBSCAN)
*   **Библиотеки для прогнозирования:**
    *   [ml-regression](https://www.npmjs.com/package/ml-regression) (для линейной регрессии)
    *   [ml-regression-simple-linear](https://www.npmjs.com/package/ml-regression-simple-linear) (простая линейная регрессия)
    *   [simple-statistics](https://www.npmjs.com/package/simple-statistics) (статистические функции)
    *   [regression](https://www.npmjs.com/package/regression) (различные типы регрессии)

## Модели прогнозирования

Приложение поддерживает несколько типов моделей машинного обучения для прогнозирования финансовых данных:

### 1. Линейная регрессия
*   **Описание**: Классическая модель, которая находит линейную зависимость между временем и значениями
*   **Применение**: Подходит для данных с четким линейным трендом
*   **Преимущества**: Простота интерпретации, быстрая работа
*   **Недостатки**: Не учитывает сезонность и нелинейные паттерны

### 2. Скользящее среднее (Moving Average)
*   **Описание**: Прогноз основан на среднем значении последних N периодов
*   **Применение**: Хорошо работает для стабильных данных без сильного тренда
*   **Преимущества**: Сглаживает случайные колебания
*   **Недостатки**: Медленно реагирует на изменения тренда

### 3. Экспоненциальное сглаживание (Exponential Smoothing)
*   **Описание**: Взвешенное среднее с убывающими весами для старых наблюдений
*   **Применение**: Универсальная модель для различных типов данных
*   **Преимущества**: Адаптивность к изменениям, простота настройки
*   **Недостатки**: Требует подбора параметра сглаживания

### 4. ARIMA-подобная модель
*   **Описание**: Упрощенная версия авторегрессионной интегрированной модели скользящего среднего
*   **Применение**: Подходит для данных с трендом и автокорреляцией
*   **Преимущества**: Учитывает временную зависимость данных
*   **Недостатки**: Более сложная настройка параметров

### 5. Prophet-подобная модель
*   **Описание**: Модель, вдохновленная Facebook Prophet, с учетом тренда и сезонности
*   **Применение**: Идеальна для данных с выраженной сезонностью
*   **Преимущества**: Автоматическое обнаружение сезонных паттернов
*   **Недостатки**: Может переобучаться на коротких временных рядах

### 6. Ансамбль моделей
*   **Описание**: Комбинирует прогнозы нескольких моделей для повышения точности
*   **Применение**: Универсальное решение для различных типов данных
*   **Преимущества**: Повышенная надежность и точность прогнозов
*   **Недостатки**: Более высокая вычислительная сложность

## Метрики оценки качества

Для оценки точности прогнозов используются следующие метрики:

*   **MAE (Mean Absolute Error)**: Средняя абсолютная ошибка - показывает среднее отклонение прогноза от фактических значений
*   **RMSE (Root Mean Square Error)**: Среднеквадратичная ошибка - более чувствительна к большим ошибкам
*   **MAPE (Mean Absolute Percentage Error)**: Средняя абсолютная процентная ошибка - показывает ошибку в процентах от фактических значений

## Анализ сезонности

Система автоматически анализирует данные на предмет сезонных паттернов:

*   **Обнаружение сезонности**: Автоматическое определение наличия повторяющихся паттернов
*   **Период сезонности**: Определение длительности сезонного цикла (в месяцах)
*   **Сила сезонности**: Оценка выраженности сезонных колебаний (0-100%)

## Развертывание на Vercel и Supabase

### Настройка Supabase

1. **Создайте проект в Supabase**:
   - Перейдите на [supabase.com](https://supabase.com)
   - Создайте новый проект
   - Скопируйте URL проекта и Anon Key

2. **Настройте базу данных**:
   - Выполните SQL-скрипты из файлов `supabase_vector_setup.sql` и `update_schema.sql`
   - Убедитесь, что таблица `transactions` создана со всеми необходимыми полями

### Развертывание на Vercel

1. **Подготовка проекта**:
   ```bash
   git add .
   git commit -m "Add forecasting functionality"
   git push origin main
   ```

2. **Настройка Vercel**:
   - Подключите GitHub репозиторий к Vercel
   - Vercel автоматически определит настройки из `vercel.json`
   - Добавьте переменные окружения в настройках проекта:
     - `SUPABASE_URL`: URL вашего Supabase проекта
     - `SUPABASE_ANON_KEY`: Anon Key из Supabase
     - `GEMINI_API_KEY`: API ключ Google Gemini

3. **Развертывание**:
   - Vercel автоматически развернет проект при каждом push
   - API функции будут доступны по адресам `/api/forecast-transactions`, `/api/deep-analysis`, etc.

### Особенности конфигурации

- **Таймауты функций**: Увеличены для сложных вычислений прогнозирования
- **Оптимизация памяти**: Функции настроены для работы с большими объемами данных
- **Автоматическое масштабирование**: Vercel автоматически масштабирует нагрузку

### Проверка работоспособности

После развертывания проверьте:
1. Загрузка главной страницы
2. Работа API эндпоинтов прогнозирования
3. Подключение к Supabase
4. Генерация прогнозов с различными моделями
