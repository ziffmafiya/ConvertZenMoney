<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (остальная часть head без изменений) ... -->
</head>
<body class="antialiased bg-[#0D1117] text-[#c9d1d9]">

    <!-- ... (остальная верстка без изменений) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ... (остальной код без изменений) ...

            async function fetchAndRenderTransactions() {
                // ... (существующий код) ...
            }

            // ИЗМЕНЕНИЕ 1: Добавляем фильтрацию по месяцу в функции отображения аномалий
            function renderAnomalies(anomalies) {
                const selectedMonth = filterMonthSelect.value;
                const selectedYear = filterYearInput.value;
                
                // Фильтруем аномалии по выбранному месяцу и году
                const filteredAnomalies = anomalies.filter(a => {
                    const date = new Date(a.date);
                    return (
                        date.getFullYear().toString() === selectedYear && 
                        String(date.getMonth() + 1).padStart(2, '0') === selectedMonth
                    );
                });

                // Остальной код функции остается без изменений, но работаем с filteredAnomalies
                anomaliesListEl.innerHTML = '';
                if (filteredAnomalies.length === 0) {
                    anomaliesListEl.innerHTML = '<p class="text-gray-500">Аномалий не найдено для выбранного месяца.</p>';
                    // ... (остальной код)
                }
                // ... (остальной код рендеринга)
            }

            // ИЗМЕНЕНИЕ 2: Модифицируем обработчик кнопки анализа аномалий
            detectAnomaliesButton.addEventListener('click', () => {
                const selectedMonth = filterMonthSelect.value;
                const selectedYear = filterYearInput.value;
                
                if (!selectedYear) {
                    alert('Пожалуйста, выберите год для анализа аномалий');
                    return;
                }
                
                detectAnomalies(selectedMonth, selectedYear);
            });

            // Модифицируем функцию detectAnomalies для принятия параметров
            async function detectAnomalies(month, year) {
                analysisResultDiv.textContent = '';
                analysisLoadingDiv.classList.remove('hidden');
                analysisLoadingDiv.querySelector('p').textContent = 'Идет поиск аномалий, это может занять некоторое время...';

                try {
                    // Отправляем запрос на сервер для обнаружения аномалий с параметрами месяца и года
                    const response = await fetch(`/api/detect-anomalies?month=${month}&year=${year}`);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to detect anomalies');
                    }
                    const result = await response.json();
                    alert(`Поиск аномалий завершен. Найдено: ${result.anomalies_found}. Данные на странице будут обновлены.`);
                    fetchAndRenderTransactions(); // Обновляем данные на странице, чтобы показать аномалии
                } catch (error) {
                    console.error('Error detecting anomalies:', error);
                    alert(`Ошибка при поиске аномалий: ${error.message}`);
                } finally {
                    analysisLoadingDiv.classList.add('hidden');
                    analysisLoadingDiv.querySelector('p').textContent = 'Анализ выполняется, пожалуйста, подождите...'; // Сбрасываем текст
                }
            }

            // ... (остальной код без изменений) ...
        });
    </script>
</body>
</html>
