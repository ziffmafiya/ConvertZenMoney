<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый Дашборд</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Light gray background for main area */
        }
        .sidebar {
            background-color: #111827; /* Dark sidebar */
            color: #e5e7eb;
            transition: width 0.3s ease;
        }
        .main-content {
            background-color: #F3F4F6;
        }
        .metric-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .status-pill {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-completed {
            background-color: rgba(34, 197, 94, 0.1);
            color: #22C55E;
        }
        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }
        .sidebar-link.active {
            background-color: #374151;
            color: #ffffff;
        }
    </style>
</head>
<body class="antialiased">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col p-4">
            <div class="flex items-center gap-3 mb-8">
                <svg class="h-8 w-8 text-emerald-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                <h1 class="text-2xl font-bold text-white">Wwealthy</h1>
            </div>
            <nav class="flex-grow">
                <ul>
                    <li><a href="#" class="sidebar-link active flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM2 10a8 8 0 1116 0 8 8 0 01-16 0z"></path></svg> Overview</a></li>
                    <li><a href="#" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm10 2a1 1 0 11-2 0 1 1 0 012 0zM6 8a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H7z"></path></svg> Budgets</a></li>
                    <li><a href="#" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zM9 13a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd"></path></svg> Expenses</a></li>
                </ul>
            </nav>
            <div class="mt-auto">
                <a href="#" class="flex items-center justify-center gap-3 px-4 py-3 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white transition">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"></path></svg>
                    Log out
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-grow p-4 md:p-8">
            <!-- Header -->
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Welcome back, Ashley</h2>
                    <p class="text-gray-500">Here's an overview of all of your balances.</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" placeholder="Type here to search" class="w-full md:w-64 pl-10 pr-4 py-2 rounded-full bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-violet-500">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                    </div>
                    <button class="text-gray-500 hover:text-gray-800 p-2 rounded-full bg-white border border-gray-300 relative">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-5-5.917V5a1 1 0 00-2 0v.083A6 6 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span class="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-violet-500"></span>
                    </button>
                    <img src="https://i.pravatar.cc/40" alt="User Avatar" class="h-10 w-10 rounded-full">
                </div>
            </header>

            <!-- Main Grid -->
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Account Balance Chart -->
                    <div class="metric-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Account Balance</h3>
                            <div class="flex items-center gap-2" id="quickFilters">
                                <button data-period="month" class="quick-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-full text-sm transition">Месяц</button>
                                <button data-period="quarter" class="quick-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-full text-sm transition">Квартал</button>
                                <button data-period="year" class="quick-filter-btn bg-violet-500 text-white font-semibold py-1 px-3 rounded-full text-sm transition active">Год</button>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="spendIncomeTrendChart"></canvas>
                        </div>
                    </div>
                    <!-- Recent Transactions Table -->
                    <div class="metric-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Recent Transactions</h3>
                            <a href="#" class="text-sm font-semibold text-violet-600 hover:underline">See all</a>
                        </div>
                        <table class="w-full text-left">
                            <thead>
                                <tr>
                                    <th class="py-2 text-gray-500 font-semibold">Name</th>
                                    <th class="py-2 text-gray-500 font-semibold">Date</th>
                                    <th class="py-2 text-gray-500 font-semibold">Status</th>
                                    <th class="py-2 text-gray-500 font-semibold text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="space-y-8">
                    <!-- Key Metrics -->
                    <div class="metric-card space-y-4">
                        <div>
                            <div class="flex justify-between items-center">
                                <h4 class="text-gray-500">Total Balance</h4>
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                            </div>
                            <p id="headerNetBalance" class="text-3xl font-bold text-gray-800 mt-1">0.00 грн</p>
                        </div>
                        <hr>
                        <div>
                            <h4 class="text-gray-500">Total Income</h4>
                            <p id="totalIncome" class="text-2xl font-bold text-green-500 mt-1">0.00 грн</p>
                        </div>
                        <hr>
                        <div>
                            <h4 class="text-gray-500">Total Expenses</h4>
                            <p id="totalExpenses" class="text-2xl font-bold text-red-500 mt-1">0.00 грн</p>
                        </div>
                    </div>
                    <!-- Habits/Insights -->
                    <div class="metric-card">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Habits Insights</h3>
                        <div id="habitsResult" class="space-y-4">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Detailed Filters -->
            <div class="hidden">
                <select id="filterMonth"><option value=""></option></select>
                <input type="number" id="filterYear">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DOM Element References ---
            const filterMonthSelect = document.getElementById('filterMonth');
            const filterYearInput = document.getElementById('filterYear');
            const quickFiltersContainer = document.getElementById('quickFilters');
            
            const headerNetBalanceEl = document.getElementById('headerNetBalance');
            const totalIncomeEl = document.getElementById('totalIncome');
            const totalExpensesEl = document.getElementById('totalExpenses');
            const transactionsTableBody = document.getElementById('transactionsTableBody');
            const habitsResultDiv = document.getElementById('habitsResult');

            // --- Chart.js Variables ---
            let spendIncomeTrendChart;

            // --- Data Fetching & Rendering ---
            async function fetchAndRenderTransactions() {
                const selectedMonth = filterMonthSelect.value;
                const selectedYear = filterYearInput.value;

                if (!selectedYear) {
                    analyzeAndRender([]);
                    return;
                }

                const params = new URLSearchParams({ year: selectedYear });
                if (selectedMonth) {
                    params.append('month', selectedMonth);
                }

                try {
                    const response = await fetch(`/api/get-transactions?${params.toString()}`);
                    if (!response.ok) throw new Error('Failed to fetch transactions');
                    const { transactions } = await response.json();
                    analyzeAndRender(transactions);
                } catch (error) {
                    console.error('Error fetching transactions:', error);
                }
            }

            function analyzeAndRender(transactions) {
                if (!transactions) return;

                let totalIncome = 0;
                let totalExpenses = 0;
                const dailyData = {};

                transactions.forEach(t => {
                    const date = t.date.split('T')[0];
                    if (!dailyData[date]) {
                        dailyData[date] = { income: 0, expenses: 0 };
                    }
                    if (t.income > 0) {
                        totalIncome += t.income;
                        dailyData[date].income += t.income;
                    } else {
                        totalExpenses += t.outcome;
                        dailyData[date].expenses += t.outcome;
                    }
                });

                const netBalance = totalIncome - totalExpenses;

                // Update metrics
                headerNetBalanceEl.textContent = `${netBalance.toLocaleString('ru-RU')} грн`;
                totalIncomeEl.textContent = `+${totalIncome.toLocaleString('ru-RU')} грн`;
                totalExpensesEl.textContent = `-${totalExpenses.toLocaleString('ru-RU')} грн`;

                // Render charts and tables
                renderTrendChart(dailyData);
                renderTransactionsTable(transactions.slice(0, 5)); // Show top 5
                // Placeholder for habits
                habitsResultDiv.innerHTML = '<p class="text-gray-500">Анализ привычек в разработке.</p>';
            }

            function renderTrendChart(dailyData) {
                if (spendIncomeTrendChart) spendIncomeTrendChart.destroy();

                const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
                const trendData = {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Расходы',
                            data: sortedDates.map(date => dailyData[date].expenses),
                            borderColor: '#EF4444',
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            yAxisID: 'y',
                        },
                        {
                            label: 'Доходы',
                            data: sortedDates.map(date => dailyData[date].income),
                            borderColor: '#22C55E',
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            yAxisID: 'y',
                        }
                    ]
                };
                
                const ctx = document.getElementById('spendIncomeTrendChart').getContext('2d');
                spendIncomeTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: trendData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { grid: { display: false } },
                            y: { position: 'left' }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            function renderTransactionsTable(transactions) {
                transactionsTableBody.innerHTML = '';
                if (transactions.length === 0) {
                    transactionsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No transactions found.</td></tr>`;
                    return;
                }
                transactions.forEach(t => {
                    const isIncome = t.income > 0;
                    const amount = isIncome ? t.income : t.outcome;
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 flex items-center gap-3">
                                <span class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600">${(t.payee || 'N/A')[0]}</span>
                                ${t.payee || 'N/A'}
                            </td>
                            <td class="py-3 text-gray-600">${new Date(t.date).toLocaleDateString('ru-RU')}</td>
                            <td class="py-3"><span class="status-pill status-completed">Completed</span></td>
                            <td class="py-3 font-semibold text-right ${isIncome ? 'text-green-500' : 'text-gray-800'}">
                                ${isIncome ? '+' : '-'}${amount.toLocaleString('ru-RU')} грн
                            </td>
                        </tr>
                    `;
                    transactionsTableBody.innerHTML += row;
                });
            }

            // --- Event Listeners ---
            quickFiltersContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('quick-filter-btn')) {
                    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                        btn.classList.remove('bg-violet-500', 'text-white');
                        btn.classList.add('bg-gray-100', 'text-gray-700');
                    });
                    e.target.classList.add('bg-violet-500', 'text-white');
                    e.target.classList.remove('bg-gray-100', 'text-gray-700');
                    
                    const period = e.target.dataset.period;
                    const today = new Date();
                    filterYearInput.value = today.getFullYear();

                    if (period === 'month') {
                        filterMonthSelect.value = String(today.getMonth() + 1).padStart(2, '0');
                    } else {
                        filterMonthSelect.value = '';
                    }
                    fetchAndRenderTransactions();
                }
            });

            // --- Initial Load ---
            filterYearInput.value = new Date().getFullYear();
            fetchAndRenderTransactions();
        });
    </script>

</body>
</html>
