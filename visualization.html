<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Cluster Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/dist/umap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        .button-container { margin-bottom: 20px; }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #0056b3; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .habit-card {
            background-color: #e9f5ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .habit-card h4 { margin-top: 0; color: #007bff; }
        .chart-container {
            margin-top: 30px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Finance Analysis Dashboard</h1>

        <div class="button-container">
            <button id="triggerClusterBtn">Trigger Clustering</button>
        </div>

        <div class="grid-container" id="habitCardsContainer">
            <!-- Habit Cards will be rendered here -->
        </div>

        <div class="chart-container">
            <h3>Cluster Visualization (UMAP Scatter Plot)</h3>
            <canvas id="scatterChart"></canvas>
        </div>
    </div>

    <script type="module">
        import { triggerCluster } from './api/trigger-clustering.js';

        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your Supabase Anon Key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.getElementById('triggerClusterBtn').addEventListener('click', async () => {
            document.getElementById('triggerClusterBtn').disabled = true;
            document.getElementById('triggerClusterBtn').textContent = 'Clustering in progress...';
            try {
                const res = await triggerCluster();
                if (res.error) {
                    alert('Clustering failed: ' + res.error.message);
                } else {
                    alert('Clustering successful!');
                    await renderVisualization();
                }
            } catch (e) {
                console.error('Error triggering clustering:', e);
                alert('An error occurred during clustering.');
            } finally {
                document.getElementById('triggerClusterBtn').disabled = false;
                document.getElementById('triggerClusterBtn').textContent = 'Trigger Clustering';
            }
        });

        async function fetchTransactions() {
            const { data: txs, error } = await supabase.from('transactions')
                .select('id, amount, date, category, cluster, description_embedding');
            if (error) {
                console.error('Error fetching transactions:', error);
                return [];
            }
            return txs;
        }

        function createHabitCard(habit) {
            return `
                <div class="habit-card">
                    <h4>${habit.title}</h4>
                    <p>Frequency: ${habit.frequency}</p>
                    <p>Average Amount: $${habit.avgAmount}</p>
                </div>
            `;
        }

        function getUniqueColors(numColors) {
            const colors = [];
            for (let i = 0; i < numColors; i++) {
                const hue = (i * 137.508) % 360; // Use golden angle approximation for distinct hues
                colors.push(`hsl(${hue}, 70%, 50%)`);
            }
            return colors;
        }

        async function renderVisualization() {
            const txs = await fetchTransactions();
            if (txs.length === 0) {
                document.getElementById('habitCardsContainer').innerHTML = '<p>No transactions found or an error occurred.</p>';
                return;
            }

            // Filter out transactions without embeddings or cluster labels
            const validTxs = txs.filter(t => t.description_embedding && t.description_embedding.length > 0 && t.cluster !== null);

            if (validTxs.length === 0) {
                document.getElementById('habitCardsContainer').innerHTML = '<p>No valid transactions with embeddings and cluster labels for visualization.</p>';
                return;
            }

            // UMAP for dimensionality reduction
            const embeddings = validTxs.map(t => t.description_embedding);
            const umap = new UMAP({ nNeighbors: 15, minDist: 0.1, nComponents: 2 });
            const coords = umap.fit(embeddings);

            // Prepare data for Chart.js Scatter Plot
            const clusterMap = new Map();
            validTxs.forEach((t, i) => {
                const clusterId = t.cluster;
                if (!clusterMap.has(clusterId)) {
                    clusterMap.set(clusterId, []);
                }
                clusterMap.get(clusterId).push({
                    x: coords[i][0],
                    y: coords[i][1],
                    id: t.id,
                    amount: t.amount,
                    date: t.date,
                    category: t.category
                });
            });

            const datasets = Array.from(clusterMap.entries()).map(([clusterId, points], index) => {
                const color = getUniqueColors(clusterMap.size)[index];
                return {
                    label: clusterId === -1 ? 'Noise' : `Cluster ${clusterId}`,
                    data: points,
                    backgroundColor: color,
                    borderColor: color,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                };
            });

            const ctx = document.getElementById('scatterChart').getContext('2d');
            if (window.scatterChartInstance) {
                window.scatterChartInstance.destroy(); // Destroy existing chart instance
            }
            window.scatterChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    return `Cluster: ${item.cluster}, Amount: $${item.amount}, Category: ${item.category}`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'UMAP Projection of Transaction Embeddings'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'UMAP Dimension 1'
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'UMAP Dimension 2'
                            }
                        }
                    }
                }
            });

            // Generate Habit Cards
            const clusters = {};
            validTxs.forEach(t => {
                if (t.cluster >= 0) { // Only consider non-noise clusters for habits
                    clusters[t.cluster] = clusters[t.cluster] || [];
                    clusters[t.cluster].push(t);
                }
            });

            const habits = Object.entries(clusters).map(([cluster, arr]) => {
                const avg = arr.reduce((s, t) => s + t.amount, 0) / arr.length;
                // Simple category aggregation: take the most frequent category or first one
                const categoryCounts = {};
                arr.forEach(t => {
                    if (t.category) {
                        categoryCounts[t.category] = (categoryCounts[t.category] || 0) + 1;
                    }
                });
                let mostFrequentCategory = `Cluster ${cluster}`;
                let maxCount = 0;
                for (const cat in categoryCounts) {
                    if (categoryCounts[cat] > maxCount) {
                        maxCount = categoryCounts[cat];
                        mostFrequentCategory = cat;
                    }
                }

                return {
                    title: mostFrequentCategory,
                    frequency: `${arr.length} txs`, // You might want to calculate this per month/week based on date range
                    avgAmount: avg.toFixed(2),
                    cluster: Number(cluster)
                };
            });

            const habitCardsContainer = document.getElementById('habitCardsContainer');
            habitCardsContainer.innerHTML = habits.map(h => createHabitCard(h)).join('');
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', renderVisualization);
    </script>
</body>
</html>
