# –°–∏—Å—Ç–µ–º–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –ø–æ–º–æ—â—å—é –∞–ª–≥–æ—Ä–∏—Ç–º–∞ HDBSCAN –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1. **Supabase Edge Function** (`supabase/functions/cluster_embeddings/index.ts`)
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é HDBSCAN –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏ –∏–∑ –ø–æ–ª—è `description_embedding`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É `transactions` —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

2. **API —Ñ—É–Ω–∫—Ü–∏–∏** (Vercel)
   - `/api/cluster-transactions.js` - –∑–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
   - `/api/get-clustered-transactions.js` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

3. **Frontend –º–æ–¥—É–ª—å** (`cluster-visualization.js`)
   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
   - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º UI

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. Supabase Edge Functions

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω Supabase CLI:

```bash
npm install -g supabase
supabase login
```

### 2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Edge Function

```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
supabase functions deploy cluster_embeddings
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í Supabase Dashboard ‚Üí Settings ‚Üí Edge Functions –¥–æ–±–∞–≤—å—Ç–µ:

```
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL —Å–∫—Ä–∏–ø—Ç–æ–≤

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ cluster_id
\i add_cluster_column_function.sql

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
\i create_transaction_clusters_table.sql
```

## üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–µ–∫—Ü–∏—é "–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5)
   - **–ú–∏–Ω–∏–º—É–º —Å–æ—Å–µ–¥–µ–π** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3)
   - **–†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ Œµ** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.5)
4. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é"

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞

- **minClusterSize**: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- **minSamples**: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Å–µ–¥–µ–π –¥–ª—è core point
- **epsilon**: —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π (–≤–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–æ–≤)

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- **–ö–ª–∞—Å—Ç–µ—Ä—ã**: –≥—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **–®—É–º**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É
- **–ö–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤**: –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É

## üîß API Endpoints

### POST /api/cluster-transactions

–ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "minClusterSize": 5,
  "minSamples": 3,
  "epsilon": 0.5
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "clusters": 3,
  "noise": 15,
  "total": 100,
  "clusterStats": {
    "0": 25,
    "1": 30,
    "2": 30
  },
  "duration": 1250
}
```

### GET /api/get-clustered-transactions

–ü–æ–ª—É—á–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `month` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –º–µ—Å—è—Ü (01-12)
- `year` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –≥–æ–¥
- `includeNoise` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: false) - –≤–∫–ª—é—á–∞—Ç—å –ª–∏ —à—É–º
- `limit` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1000) - –ª–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `includeEmbeddings` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: false) - –≤–∫–ª—é—á–∞—Ç—å –ª–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏

**–û—Ç–≤–µ—Ç:**
```json
{
  "transactions": [...],
  "clusters": {
    "0": {
      "id": 0,
      "transactions": [...],
      "summary": {
        "count": 25,
        "totalOutcome": 15000,
        "avgOutcome": 600,
        "topCategory": "–ü—Ä–æ–¥—É–∫—Ç—ã",
        "topPayee": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç"
      }
    }
  },
  "summary": {
    "total": 100,
    "clustered": 85,
    "noise": 15,
    "clusterCount": 3
  }
}
```

## üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

### –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

–ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- ID –∫–ª–∞—Å—Ç–µ—Ä–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –°—Ä–µ–¥–Ω—é—é —Å—É–º–º—É
- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- –¢–æ–ø –ø–æ–ª—É—á–∞—Ç–µ–ª—è

### –ì—Ä–∞—Ñ–∏–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º.

## üîç –ê–ª–≥–æ—Ä–∏—Ç–º HDBSCAN

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç HDBSCAN:

1. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–æ—Å–µ–¥–µ–π**: –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –Ω–∞—Ö–æ–¥–∏–º —Å–æ—Å–µ–¥–µ–π –≤ —Ä–∞–¥–∏—É—Å–µ Œµ
2. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ core points**: —Ç–æ—á–∫–∏ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ—Å–µ–¥–µ–π
3. **–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤**: –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö core points
4. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- –£—Å—Ç–æ–π—á–∏–≤ –∫ —à—É–º—É
- –ù–∞—Ö–æ–¥–∏—Ç –∫–ª–∞—Å—Ç–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ `ClusterVisualization`
2. –î–æ–±–∞–≤—å—Ç–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã –≤ `createUI()`
3. –ü—Ä–∏–≤—è–∂–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ `bindEvents()`

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ö—ç—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

- –î–æ–±–∞–≤—å—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –º–µ–∂–¥—É –ø–µ—Ä–∏–æ–¥–∞–º–∏
- –î–æ–±–∞–≤—å—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∞ "Edge function not found"

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞:
```bash
supabase functions list
```

### –û—à–∏–±–∫–∞ "Column cluster_id does not exist"

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Ñ—É–Ω–∫—Ü–∏—é:
```sql
SELECT add_cluster_column_if_not_exists();
```

### –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è

- –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –£–≤–µ–ª–∏—á—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä epsilon
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–µ

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ Edge Function –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Supabase Dashboard:
Dashboard ‚Üí Edge Functions ‚Üí cluster_embeddings ‚Üí Logs

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Edge Function –∏—Å–ø–æ–ª—å–∑—É–µ—Ç service role key –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- API —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- Frontend –Ω–µ –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å–ª–µ–¥—É–µ—Ç —Ç–µ–º –∂–µ —É—Å–ª–æ–≤–∏—è–º –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏—è. 